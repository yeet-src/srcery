#!/usr/bin/env srcery-bash

repo="${1:?usage: @wt-create REPO [BRANCH [BASE]]}"
branch="${2:-}"
base="${3:-}"
repo_path="$YEET_SRC_ROOT/$repo"

[[ -d "$repo_path/.git" ]] || die "$repo_path is not a git repo"

log() { echo "${*//$HOME/\~}" >&2; }

if [[ -n "$branch" ]]; then
	# user-chosen name; sanitize / for directory name
	name="${branch//\//-}"
	wt_path="$SRCERY_DATA/worktrees/$name"
else
	id=$(head -c4 /dev/urandom | xxd -p)
	branch="wt_${id}"
	name="wt_${id}_${repo}"
	wt_path="$SRCERY_DATA/worktrees/$name"
fi

mkdir -p "$SRCERY_DATA/worktrees"

if [[ -f "$wt_path/.git" ]]; then
	# existing valid worktree â€” reuse it
	log "reusing $wt_path"
	echo "$wt_path"
	exit 0
fi

# clean up stale directory if present
[[ -d "$wt_path" ]] && rm -rf "$wt_path"

# check if branch already exists
if git -C "$repo_path" show-ref --verify --quiet "refs/heads/$branch"; then
	if [[ -n "$base" ]]; then
		die "branch '$branch' already exists; BASE arg not supported for existing branches"
	fi
	git -C "$repo_path" worktree add -q "$wt_path" "$branch"
elif [[ -n "$base" ]]; then
	git -C "$repo_path" worktree add -q "$wt_path" -b "$branch" "$base"
else
	git -C "$repo_path" worktree add -q "$wt_path" -b "$branch"
fi

log "$wt_path"
echo "$wt_path"

# repo-defined hooks (make targets)
# unset SHELLOPTS so make recipes get a clean shell
if env -u SHELLOPTS make -C "$wt_path" -n wt_init >/dev/null 2>&1; then
	env -u SHELLOPTS make -C "$wt_path" --no-print-directory wt_init >&2
fi

if env -u SHELLOPTS make -C "$wt_path" -n wt_run >/dev/null 2>&1; then
	env -u SHELLOPTS @svc-start "$wt_path" run make --no-print-directory wt_run >&2
fi
