#!/usr/bin/env srcery-bash

repo="${1:?usage: @wt-create REPO}"
repo_path="$YEET_SRC_ROOT/$repo"

[[ -d "$repo_path/.git" ]] || die "$repo_path is not a git repo"

base_branch=$(git -C "$repo_path" branch --show-current)
log() { echo "${*//$HOME/\~}" >&2; }

log "base: ${base_branch:-detached HEAD}"

id=$(head -c4 /dev/urandom | xxd -p)
name="wt_${id}_${repo}"
wt_path="$SRCERY_DATA/worktrees/$name"

mkdir -p "$SRCERY_DATA/worktrees"
git -C "$repo_path" worktree add -q "$wt_path" -b "wt_${id}"

log "$wt_path"
echo "$wt_path"

# repo-defined hooks (make targets)
# unset SHELLOPTS so make recipes get a clean shell
if env -u SHELLOPTS make -C "$wt_path" -n wt_init >/dev/null 2>&1; then
	env -u SHELLOPTS make -C "$wt_path" --no-print-directory wt_init >&2
fi

if env -u SHELLOPTS make -C "$wt_path" -n wt_run >/dev/null 2>&1; then
	env -u SHELLOPTS @svc-start "$wt_path" "$repo" make --no-print-directory wt_run >&2
fi
