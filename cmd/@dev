#!/usr/bin/env srcery-bash

repo="${1:?usage: @dev REPO [BRANCH [BASE]]}"
branch="${2:-}"
base="${3:-}"
: "${CLAUDE_BIN:=claude}"

wt_path=$(@wt-create "$repo" "$branch" "$base")
wt_name=$(basename "$wt_path")
win="${wt_name}/claude"

# Write Claude Code hook config for status notifications
mkdir -p "$wt_path/.claude"
cat > "$wt_path/.claude/settings.local.json" <<EOF
{
  "hooks": {
    "Notification": [{
      "matcher": "idle_prompt|permission_prompt",
      "hooks": [{"type": "command", "command": "${SRCERY_ROOT}/lib/srcery-notify"}]
    }],
    "UserPromptSubmit": [{
      "hooks": [{"type": "command", "command": "${SRCERY_ROOT}/lib/srcery-notify"}]
    }]
  }
}
EOF

@svc-start "$wt_path" claude \
	env "SRCERY_SVC_WINDOW=$win" "SRCERY_DATA=$SRCERY_DATA" \
	zsh -c "SHELL=bash $CLAUDE_BIN --allow-dangerously-skip-permissions \
		--append-system-prompt 'You are a background worktree agent managed by srcery. Work autonomously â€” do not ask clarifying questions unless truly stuck. Commit eagerly after completing logical units of work. When finished, leave the worktree in a clean committed state with no uncommitted changes.'; exec zsh" >&2

exec tmux -L "$SRCERY_TMUX_SOCKET" attach-session -t "=srcery:=$win"
