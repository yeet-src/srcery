#!/usr/bin/env srcery-bash

name="${1:?usage: @wt-remove NAME}"

# strip path prefix if given
name="${name##*/}"

# parse wt_${id}_${repo}
repo="${name#wt_*_}"
[[ "$repo" != "$name" ]] || { @wt-list >&2; die "can't parse repo from name: $name"; }

# stop any services running in this worktree
if srcery_tmux has-session -t "=srcery" 2>/dev/null; then
	srcery_tmux list-windows -t "=srcery" -F '#{window_name}' \
	| while read -r win; do
		[[ "$win" == "${name}/"* ]] && @svc-stop "$win"
	done
fi

git -C "$YEET_SRC_ROOT/$repo" worktree remove --force "$SRCERY_DATA/worktrees/$name" 2>&1 \
  || { @wt-list >&2; die "failed to remove worktree: $name"; }
