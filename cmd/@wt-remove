#!/usr/bin/env srcery-bash

name="${1:?usage: @wt-remove NAME}"

# strip path prefix if given
name="${name##*/}"

wt_path="$SRCERY_DATA/worktrees/$name"
[[ -d "$wt_path" ]] || die "no such worktree directory: $name"

# stop any services running in this worktree
if srcery_tmux has-session -t "=srcery" 2>/dev/null; then
	srcery_tmux list-windows -t "=srcery" -F '#{window_name}' \
	| while read -r win; do
		[[ "$win" != "${name}/"* ]] || @svc-stop "$win"
	done
fi

if [[ -f "$wt_path/.git" ]]; then
	# derive repo path and branch before removing
	gitdir=$(<"$wt_path/.git")
	gitdir="${gitdir#gitdir: }"
	repo_path="${gitdir%/.git/worktrees/*}"
	wt_branch=$(git -C "$wt_path" branch --show-current 2>/dev/null || true)

	git -C "$repo_path" worktree remove --force "$wt_path" 2>&1 \
	  || { @wt-list >&2; die "failed to remove worktree: $name"; }
	# clean up untracked files git may have left behind
	[[ ! -d "$wt_path" ]] || rm -rf "$wt_path"

	# delete branch if it has no unmerged work (-d refuses otherwise)
	if [[ -n "$wt_branch" ]]; then
		git -C "$repo_path" branch -d "$wt_branch" 2>/dev/null || true
	fi
else
	# stale directory (git worktree already removed) â€” clean up
	rm -rf "$wt_path"
fi
