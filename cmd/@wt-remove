#!/usr/bin/env srcery-bash

name="${1:?usage: @wt-remove NAME}"

# strip path prefix if given
name="${name##*/}"

wt_path="$SRCERY_DATA/worktrees/$name"
[[ -f "$wt_path/.git" ]] || { @wt-list >&2; die "not a worktree: $name"; }

# derive repo path from worktree's .git file
# format: "gitdir: /path/to/repo/.git/worktrees/xxx"
gitdir=$(<"$wt_path/.git")
gitdir="${gitdir#gitdir: }"
repo_path="${gitdir%/.git/worktrees/*}"

# stop any services running in this worktree
if srcery_tmux has-session -t "=srcery" 2>/dev/null; then
	srcery_tmux list-windows -t "=srcery" -F '#{window_name}' \
	| while read -r win; do
		[[ "$win" == "${name}/"* ]] && @svc-stop "$win"
	done
fi

git -C "$repo_path" worktree remove --force "$wt_path" 2>&1 \
  || { @wt-list >&2; die "failed to remove worktree: $name"; }
